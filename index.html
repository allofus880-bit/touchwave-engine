<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>EP12 + TouchWave Integrated Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    html, body {
        margin: 0;
        padding: 0;
        background: black;
        overflow: hidden;
        height: 100%;
    }
    canvas {
        display: block;
    }
    #fileInput {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 20;
        background: #fff;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 16px;
    }
</style>
</head>
<body>

<input id="fileInput" type="file" accept="audio/*">
<canvas id="cv"></canvas>

<!-- TouchWave socket.io -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// =======================================================
// 0) TouchWave Variables
// =======================================================
let twX = 0.5;      // normalized 0~1
let twY = 0.5;
let twTime = -9999;

// Connect to TouchWave Server
const socket = io("https://touchwave-server.vercel.app", {
    transports: ["websocket", "polling"]
});

socket.on("connect", () => console.log("ðŸ”µ TouchWave Connected"));

socket.on("touchwave", ({ x, y }) => {
    console.log("TouchWave Signal:", x, y);

    // 3ì´ˆ ë”œë ˆì´(ìœ íŠœë¸Œ ë°©ì†¡ ì§€ì—° ë³´ì •)
    setTimeout(() => {
        twX = x;
        twY = y;
        twTime = performance.now() * 0.001;
    }, 3000);
});

// =======================================================
// 1) Canvas + Audio Engine
// =======================================================
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");

function resize() {
    cv.width = window.innerWidth;
    cv.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

let audioCtx = null;
let analyser = null;
let dataArray = null;

function initAudioFile(file) {
    if (!audioCtx) audioCtx = new AudioContext();

    const reader = new FileReader();
    reader.onload = ev => {
        audioCtx.decodeAudioData(ev.target.result, buffer => {
            const src = audioCtx.createBufferSource();
            src.buffer = buffer;

            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 1024;
            dataArray = new Uint8Array(analyser.frequencyBinCount);

            src.connect(analyser);
            analyser.connect(audioCtx.destination);
            src.start(0);

            document.getElementById("fileInput").style.display = "none";
        });
    };
    reader.readAsArrayBuffer(file);
}

document.getElementById("fileInput").onchange = e => {
    const file = e.target.files[0];
    if (file) initAudioFile(file);
};

function getAudioLevel() {
    if (!analyser) return 0;
    analyser.getByteFrequencyData(dataArray);
    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
    return (sum / dataArray.length) / 255;
}

// =======================================================
// 2) Heart Drawing
// =======================================================
function drawHeart(scale, color) {
    ctx.save();
    ctx.translate(cv.width / 2, cv.height / 2);
    ctx.scale(scale, scale);

    ctx.beginPath();
    for (let a = 0; a < Math.PI * 2; a += 0.03) {
        let x = 16 * Math.pow(Math.sin(a), 3);
        let y = -(13 * Math.cos(a) - 5 * Math.cos(2 * a) - 2 * Math.cos(3 * a) - Math.cos(4 * a));
        ctx.lineTo(x, y);
    }
    ctx.closePath();

    ctx.fillStyle = color;
    ctx.fill();
    ctx.restore();
}

// =======================================================
// 3) Render Loop
// =======================================================
function loop(t) {
    ctx.clearRect(0, 0, cv.width, cv.height);
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, cv.width, cv.height);

    const audioLevel = getAudioLevel();

    // ì•ˆì •ì  Pulse + ì˜¤ë””ì˜¤ ë°˜ì‘
    const fakePulse = (Math.sin(t * 0.002 * 2) + 1) * 0.3;
    const pulse = 0.4 + audioLevel * 0.9 + fakePulse;

    // TouchWave Shockwave ì˜í–¥
    let twInfluence = 0;
    const elapsed = t * 0.001 - twTime;
    if (elapsed > 0 && elapsed < 3) {
        twInfluence = (1 - elapsed / 3) * 0.6;
    }

    const baseSize = Math.min(cv.width, cv.height) * 0.03;
    const totalPulse = pulse + twInfluence;

    drawHeart(baseSize * (0.9 + totalPulse * 0.4), "#ffdd88");
    drawHeart(baseSize * (0.7 + totalPulse * 0.25), "#ffcc66");
    drawHeart(baseSize * (0.5 + totalPulse * 0.15), "#ffffff");

    requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
